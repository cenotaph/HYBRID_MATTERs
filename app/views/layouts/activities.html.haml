!!!
%html
  %head
    %meta{:content => "text/html; charset=UTF-8", "http-equiv" => "Content-Type"}/
    %meta{:content => "width=device-width, initial-scale=1.0", :name => "viewport"}/
    = display_meta_tags :site => 'HYBRID MATTERs', og: {image: "http://#{request.host}#{image_path('hm_logo.png')}" }
    = stylesheet_link_tag    'application', media: 'all'
    = javascript_include_tag 'application', 'data-turbolinks-track' => true 
    %script{:src => "https://maps.googleapis.com/maps/api/js?key=#{Figaro.env.google_maps_api_key}", :type => "text/javascript"}
    = csrf_meta_tags
    %link{:href => "/posts.rss", :rel => "alternate", :title => "RSS", :type => "application/rss+xml"}/
    %link{:href => "http://fonts.googleapis.com/css?family=Roboto:400italic,300,300italic,400", :rel => "stylesheet", :type => "text/css"}/
    :javascript
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-60278881-1', 'auto');
      ga('send', 'pageview');
  %body
    - unless flash.empty?
      #flash
        .row
          .small-12.columns.text-center
            - flash.each do |name, msg|
              - if msg.is_a?(String)
                = content_tag :div, msg, :id => "flash_#{name}"
    - unless @background_image.nil?
      :css
        header{
          background: url(#{@background_image.regular.url}) no-repeat top center;
        }
        @media only screen and (max-width: 40em)  { 
          header {
            background: url(#{@background_image.mobile .url}) no-repeat top center;
          }
        }
        
    %header{class: @background_image.nil? ? "type" + [1,2,3].sample.to_s : false }
      - unless @background_image.nil?
        - unless @background_image.credit.blank?
          .image_credit= link_to 'IMAGE CREDITS', '#', onclick: "$(this).text('#{escape_javascript(@background_image.credit)}');return false;"
      - if user_signed_in?  
        - if current_user.has_role?(:partner) || current_user.has_role?(:admin)
          .right
            = link_to 'Back office', '/admin', class: [:button, :tiny]
      = link_to '/' do
        - if Rails.env.staging?
          .staging_overlay= image_tag('staging_overlay.png')
        .before
        .grid-container

      %nav.top-bar.sticky
        .hor-container.initial
          .row
      
            .menu_wrapper
              .social.hide-for-small-only
                = link_to image_tag('icon_fb.png', onmouseover: "this.src='#{image_path('icon_fb_hover.png')}'", onmouseout: "this.src='#{image_path('icon_fb.png')}'"), 'https://www.facebook.com/groups/437255773056631/', target: :_blank, class: :facebook_link
                = link_to image_tag('icon_twitter.png', onmouseover: "this.src='#{image_path('icon_twitter_hover.png')}'", onmouseout: "this.src='#{image_path('icon_twitter.png')}'"), 'http://twitter.com/hybridmatters', target: :_blank, class: :twitter_link
                = link_to image_tag('icon_post.png', onmouseover: "this.src='#{image_path('icon_post_hover.png')}'", onmouseout: "this.src='#{image_path('icon_post.png')}'"), 'mailto:info@bioartsociety.fi', class: :maillink
              
              .rest
                %ul.top-bar-menu
                  %li{class: controller.controller_name == 'pages' && params[:id] == 'about' ? :active : false}= link_to 'About', page_path('about')
                  %li{class: controller.controller_name == 'posts' ? :active : false}= link_to 'News', posts_path
                  %li{class: controller.controller_name == 'partners' ? :active : false}= link_to 'Partners', partners_path
                  %li{class: controller.controller_name == 'activities'  ? :active : false}= link_to 'Programme', activities_path
          .row
            .down_arrow_wrapper
              .social &nbsp;
              .rest
                %ul.top-bar-menu
                  %li{class: controller.controller_name == 'pages' && params[:id] == 'about' ? :active : false}
                    %span About
                  %li{class: controller.controller_name == 'posts' ? :active : false}
                    %span News
                  %li{class: controller.controller_name == 'partners' ? :active : false}
                    %span Partners
                  %li{class: controller.controller_name == 'activities'  ? :active : false}
                    %span Programme
      - if controller.controller_name == 'activities'
        %nav.activities-bar.sticky
          .hor-container.secondary_activities_filter
            .row
              .menu_wrapper
                %ul.top-bar-menu
                  - Activitytype.order_by(:sort_order.asc).each do |at|
                    - if at.activities.map(&:subsite).compact.empty?
                      %li= at.name
                    - else
                      -  at.activities.delete_if{|x| x.subsite.nil?}.compact.each do |a|
                        %li= link_to a.name, "http://" + a.subsite.subdomains.split(',').compact.first.strip.downcase + ".hybridmatters.net"
            
                
                
      
    .main-container{class: controller.controller_name}
      .blue_announcements.show-for-small-only
        .row
          .small-12.columns.text-center.small-centered.heading ANNOUNCEMENTS
        
        - @sticky.each do |post|
          .row
            .small-6.columns.titlex.text-left
              .title= link_to post.title, post
              .date= post.published_at.strftime("%d %b %Y")
            .small-6.columns.blurb_mobile
              = post.short_abstract.blank? ? truncate_html(strip_tags(post.body), length: 100) : post.short_abstract
              = link_to '>>>', post
    #map_container
      .inner_container= yield


    - unless @sticky.empty?
      #sticky_blue_box.hide-for-small-only
        .heading.ui-draggable-handle
          ANNOUNCEMENTS
        
        - @sticky.each do |post|
          .title_box.text-center{style: "padding: #{3.25 - @sticky.size }rem 0;"}
            .title= post.title
            .date= post.published_at.strftime("%d %b %Y")
          .blurb{style: "padding: #{3.25 - @sticky.size }rem 0;"}
            = post.short_abstract.blank? ? truncate_html(strip_tags(post.body), length: 120) : post.short_abstract
            = link_to '>>>', post
      = content_for :jquery do
        :plain  
          $('#sticky_blue_box').dialog({draggable: false, resizable: false, position: { my: "right-40 bottom-40", at: "right bottom-40", of: $('.initial')}}).parent().draggable();
          $('.ui-dialog').draggable( "option", "containment", 'html');
          $('#sticky_blue_box .title_box').mouseenter(function() {
            $('#sticky_blue_box .blurb').css('display', 'none');
            $('#sticky_blue_box .title_box').css('display', 'block');
            $(this).toggle();
            $(this).next('.blurb').toggle();
          });
          $('#sticky_blue_box').mouseleave(function() {
            $('#sticky_blue_box .blurb').css('display', 'none');
            $('#sticky_blue_box .title_box').css('display', 'block');
          });
          $('.blurb').css('height', $('.blurb').prev('.title_box').css('height'));
    = render partial: 'layouts/footer'

                     
    :javascript
      $(document).ready(function() { #{yield :jquery} 
        if ($('#activity_map_wrapper').height() > $('#map_left').height()) {
          $('#map_left').css('min-height', $('#activity_map_wrapper').height() + 200);
          }
        //$('#sticky_blue_box').dialog({draggable: false, resizable: false, position: { my: "right-40 bottom", at: "right bottom-40", of: $('.hor-container')}})
        $('.ui-dialog').css('top', 220);
      });